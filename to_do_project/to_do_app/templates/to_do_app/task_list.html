{% extends 'to_do_app/base.html' %}

{% block content %}
<h1 class="page-title">My Tasks</h1>

<!-- Progress Dashboard -->
<div class="dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
    <div class="stat-card" style="background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; text-align: center; transition: all 0.3s ease; border-top: 4px solid var(--primary-color);">
        <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color); display: block; line-height: 1; margin-bottom: 0.5rem;">{{ completed_today }}</div>
        <div class="stat-label" style="font-size: 1.1rem; color: var(--text-light); font-weight: 600;">Tasks Completed Today</div>
    </div>
    <div class="stat-card" style="background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; text-align: center; transition: all 0.3s ease; border-top: 4px solid var(--primary-color);">
        <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color); display: block; line-height: 1; margin-bottom: 0.5rem;">{{ total_tasks }}</div>
        <div class="stat-label" style="font-size: 1.1rem; color: var(--text-light); font-weight: 600;">Total Tasks</div>
    </div>
    <div class="stat-card" style="background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); padding: 2rem; text-align: center; transition: all 0.3s ease; border-top: 4px solid var(--primary-color);">
        <div class="stat-value" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color); display: block; line-height: 1; margin-bottom: 0.5rem;">{{ pending_tasks }}</div>
        <div class="stat-label" style="font-size: 1.1rem; color: var(--text-light); font-weight: 600;">Pending Tasks</div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card">
    <div class="search-section">
        <form method="GET" action="{% url 'task_list' %}" class="search-form">
            <div class="search-box" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <!-- Text Search -->
                <div style="flex: 1; min-width: 200px;">
                    <input 
                        type="text" 
                        name="q" 
                        placeholder="Search tasks by title or description..." 
                        value="{{ request.GET.q }}"
                        class="search-input"
                        style="width: 100%; padding: 1rem; border: 2px solid rgba(167, 139, 250, 0.2); border-radius: var(--border-radius-sm); background: var(--card-bg); color: var(--text-color); font-size: 1rem;"
                    >
                </div>
                
                <!-- Category Filter -->
                <div style="min-width: 150px;">
                    <select name="category" class="category-filter" style="width: 100%; padding: 1rem; border: 2px solid rgba(167, 139, 250, 0.2); border-radius: var(--border-radius-sm); background: var(--card-bg); color: var(--text-color); font-size: 1rem;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if request.GET.category == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div style="min-width: 150px;">
                    <select name="status" class="status-filter" style="width: 100%; padding: 1rem; border: 2px solid rgba(167, 139, 250, 0.2); border-radius: var(--border-radius-sm); background: var(--card-bg); color: var(--text-color); font-size: 1rem;">
                        <option value="">All Status</option>
                        <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="submit" class="search-btn" style="background: var(--gradient-primary); color: white; border: none; padding: 1rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                        <span>üîç</span> Search
                    </button>
                    
                    {% if request.GET.q or request.GET.category or request.GET.status %}
                    <a href="{% url 'task_list' %}" class="clear-search" style="background: var(--gradient-secondary); color: white; border: none; padding: 1rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease;">
                        <span>‚úï</span> Clear All
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Search Results Info -->
{% if request.GET.q or request.GET.category or request.GET.status %}
<div class="search-results-info" style="text-align: center; margin: 1rem 0; padding: 1.5rem; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); border-left: 4px solid var(--primary-color);">
    <p style="margin: 0; color: var(--text-color); font-style: normal; font-weight: 600;">
        üîç Found <strong style="color: var(--primary-color);">{{ tasks.count }}</strong> task(s)
        {% if request.GET.q %}matching "<strong style="color: var(--accent-color);">"{{ request.GET.q }}"</strong>"{% endif %}
        {% if request.GET.q and request.GET.category %}and{% endif %}
        {% if request.GET.category %}in category "<strong style="color: var(--accent-color);">{{ request.GET.category }}</strong>"{% endif %}
        {% if request.GET.status %}with status "<strong style="color: var(--accent-color);">{{ request.GET.status }}</strong>"{% endif %}
    </p>
    {% if tasks.count == 0 %}
    <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">
        No tasks match your filters. <a href="{% url 'add_task' %}" style="color: var(--primary-color); font-weight: 600;">Add a new task</a> or <a href="{% url 'task_list' %}" style="color: var(--primary-color); font-weight: 600;">clear filters</a>
    </p>
    {% endif %}
</div>
{% endif %}

<!-- Quick Filter Buttons -->
<div class="card">
    <div style="text-align: center; padding: 1rem;">
        <h3 style="margin-bottom: 1rem; color: var(--text-color);">Quick Filters</h3>
        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
            <a href="{% url 'task_list' %}?status=pending" class="btn btn-sm btn-warning" style="text-decoration: none;"> Pending Tasks</a>
            <a href="{% url 'task_list' %}?status=completed" class="btn btn-sm btn-success" style="text-decoration: none;"> Completed Tasks</a>
            {% for category in categories|slice:":3" %}
            <a href="{% url 'task_list' %}?category={{ category }}" class="btn btn-sm btn-secondary" style="text-decoration: none;">{{ category }} Tasks</a>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Task List -->
<div class="card">
    {% if tasks %}
    <ul class="task-list">
        {% for task in tasks %}
        <li class="task-item {% if task.completed %}task-completed{% endif %}" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: var(--card-bg); margin-bottom: 1rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: none; transition: all 0.3s ease;">
            <div class="task-info" style="flex-grow: 1;">
                <div class="task-title" style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--text-color);">
                    {{ task.title }}
                    {% if task.is_overdue %}
                    <span style="background: var(--danger-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">
                        ‚ö†Ô∏è Overdue
                    </span>
                    {% endif %}
                </div>
                {% if task.description %}
                <div class="task-description" style="color: var(--text-light); font-size: 0.9rem; margin: 0.5rem 0;">
                    {{ task.description|truncatewords:20 }}
                </div>
                {% endif %}
                <div class="task-meta" style="font-size: 0.875rem; color: var(--text-light);">
                    <span class="category-badge category-{{ task.category|lower }}" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; color: white; background: var(--gradient-primary);">
                        {{ task.category }}
                    </span>
                    {% if task.due_date %}
                    <span style="display: inline-flex; align-items: center; gap: 0.25rem; margin-right: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: rgba(139, 92, 246, 0.1); color: var(--primary-color);">
                        üìÖ {{ task.due_date }}
                        {% if task.days_until_due == 0 and not task.completed %}
                        <span style="background: var(--warning-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">
                            Today!
                        </span>
                        {% elif task.days_until_due < 0 and not task.completed %}
                        <span style="background: var(--danger-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">
                            Overdue!
                        </span>
                        {% endif %}
                    </span>
                    {% endif %}
                    {% if task.completed %}
                    <span class="status-badge status-completed" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; background: var(--primary-color); color: white;">
                         Completed
                    </span>
                    {% else %}
                    <span class="status-badge status-pending" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; background: var(--primary-color); color: white;">
                         Pending
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="task-actions" style="display: flex; gap: 0.75rem;">
                {% if task.attachment %}
                <a href="{{ task.attachment.url }}" target="_blank" class="btn btn-sm btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; background: var(--gradient-secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600; text-decoration: none; transition: all 0.3s ease;">
                    üìÇ View File
                </a>
                {% else %}
                <span style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; background: rgba(139, 92, 246, 0.1); color: var(--primary-color);">
                    ‚ùå No File
                </span>
                {% endif %}

                <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; background: var(--gradient-secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600; text-decoration: none; transition: all 0.3s ease;">
                     Edit
                </a>
                {% if not task.completed %}
                <form method="post" action="{% url 'toggle_task' task.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success" style="display: inline-flex; align-items: center; gap: 0.5rem; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease;">
                        ‚úì Complete
                    </button>
                </form>
                {% endif %}
                <form method="post" action="{% url 'delete_task' task.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this task?')" style="display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.3s ease;">
                        Delete
                    </button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="text-center" style="padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
        <h3 style="color: var(--text-light); margin-bottom: 1rem;">
            {% if request.GET.q or request.GET.category or request.GET.status %}
            No tasks found matching your filters
            {% else %}
            No tasks yet
            {% endif %}
        </h3>
        <p style="color: var(--text-light); margin-bottom: 2rem;">
            {% if request.GET.q or request.GET.category or request.GET.status %}
            Try adjusting your search criteria or clear all filters.
            {% else %}
            Get started by creating your first task!
            {% endif %}
        </p>
        <a href="{% url 'add_task' %}" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.1rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
             Add Your First Task
        </a>
        {% if request.GET.q or request.GET.category or request.GET.status %}
        <a href="{% url 'task_list' %}" class="btn btn-secondary" style="padding: 1rem 2rem; font-size: 1.1rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
            ‚úï Clear Filters
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}